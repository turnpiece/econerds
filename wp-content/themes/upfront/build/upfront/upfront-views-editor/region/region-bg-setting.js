!function(e){var t=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["scripts/upfront/upfront-views-editor/modal-bg-setting","scripts/upfront/upfront-views-editor/fields","text!upfront/templates/region_edit_panel.html","scripts/perfect-scrollbar/perfect-scrollbar"],function(n,i,o,s){return n.extend({events:{"click .upfront-inline-modal-cancel":"on_click_cancel","click .upfront-inline-modal-content":"on_click_content","click .uf-settings-panel__title":"toggle_advanced_settings","click .upfront-inline-modal-save":"on_click_save"},reset_models:function(){if("undefined"!=typeof this.oldData){var e=this.model.get("properties").models,t=this.oldData;this.revert_models_to_previous(e,t)}},revert_models_to_previous:function(e,t){e.map(function(e,n){var i=t[n];i&&"undefined"!=typeof i.name&&(e.set("name",i.name),e.set("value",i.value))})},save_current_models:function(){var e=[],t=this.model.get("properties").models;t.map(function(t){e.push(_.clone(t.attributes))}),this.oldData=e},render_modal:function(t,n){var i=this.get_template(),o=i();t.find(".upfront-region-bg-setting-tab-primary, .upfront-region-bg-setting-tab-secondary").children().detach(),t.html(o),n.addClass("upfront-region-modal-bg"),this.render_header_settings(t.find(".upfront-region-bg-setting-header")),this.render_main_settings(t),this.render_footer_settings(t.find(".upfront-region-bg-setting-footer")),this.render_bg_type_settings(t),this.render_padding_settings(t.find(".upfront-region-bg-setting-padding"));var r=this.$el.find(".uf-region-bg-settings-panel-content");r=r[0]||!1,r&&(this.set_settings_content_max_height(),s.withDebounceUpdate(r,!0,"region:background:type:changed",!0),Upfront.Events.on("color:spectrum:show",function(){e(r).css("position","initial")}),Upfront.Events.on("color:spectrum:hide",function(){e(r).css("position","relative")})),"region-settings-sidebar"===this.$el.parent().attr("id")&&(e("#sidebar-ui").addClass("region-settings-activated"),this.save_current_models())},set_settings_content_max_height:function(){var e=this.$el.height(),t=this.$el.find(".upfront-region-bg-setting-header").first().outerHeight(!0),n=this.$el.find(".upfront-settings_panel.advanced-settings").first().outerHeight(!0);this.$el.find(".uf-region-bg-settings-panel-content").css("max-height",e-t-n-70+"px")},close:function(t){return e("#sidebar-ui").removeClass("region-settings-activated"),n.prototype.close.call(this,t)},get_template:function(){var t=e(o);return _.template(t.find("#upfront-region-bg-setting").html())},get_bg_types:function(){var e=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),n=this.model.get_property_value_by_name("background_type"),i=[{label:t.solid_color,value:"color",icon:"color"},{label:t.image,value:"image",icon:"image"},{label:t.video,value:"video",icon:"video"},{label:t.image_slider,value:"slider",icon:"slider"},{label:t.map,value:"map",icon:"map"}];return e&&!e.default&&i.unshift({label:t.inherit,value:"",icon:n?n:"color"}),(_upfront_post_data.post_id||!0===Upfront.plugins.isRequiredByPlugin("show feature image region type")&&Upfront.Application.is_single())&&(Upfront.Application.is_single("404_page")||i.push({label:t.featured_image,value:"featured",icon:"feat"})),i},get_region_types:function(e){var n=[{label:t.full_width,value:"wide"},{label:t.contained,value:"clip"}];return e>0?n:_.union([{label:t.full_screen,value:"full"}],n)},render_header_settings:function(n){var s=this,r=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),l=r&&!r.default,a=!this.model.is_main()&&this.model.get("sub"),g=e(o),d=_.template(g.find("#upfront-region-bg-setting-name").html()),p=new i.Text({model:this.model,name:"title",placeholder:t.region_name_placeholder,compact:!0,change:function(){},blur:function(){var t,n,i,o=this.model.collection,r=this.model.get("title"),l=(this.model.get("name"),e.trim(this.get_value().replace(/[^A-Za-z0-9\s_-]/g,""))),a=l.toLowerCase().replace(/\s/g,"-");r!=l&&(o.get_by_name(a)&&(t=o.get_new_title(l+" ",2),l=t.title,a=t.name),i=s.get_region_css_styles(this.model),this.model.is_main()?(n=this.model.get_sub_regions(),_.each(n,function(e,t){_.isArray(e)?_.each(e,function(e){e.set({container:a},{silent:!0})}):_.isObject(e)&&e.set({container:a},{silent:!0})}),this.model.set({title:l,name:a,container:a},{silent:!0})):this.model.set({title:l,name:a},{silent:!0}),f.find(".upfront-region-name-edit-value").text(l),s.set_region_css_styles(this.model,i.styles,i.selector),this.model.get("properties").trigger("change"))},rendered:function(){var e=this;this.get_field().on("keyup",function(t){13===t.which&&e.trigger("blur")})}}),c=new i.Button({model:this.model,name:"scope",classname:"upfront-region-bg-setting-globalize",label:t.make_global,compact:!0,on_click:function(){s.apply_region_scope(this.model,"global"),h.show(),f.find(".upfront-region-bg-setting-is-global").show(),u.$el.show(),this.$el.hide()}}),u=new i.Button({model:this.model,name:"localize",label:t.localize_region,classname:"upfront-region-bg-setting-localize",compact:!0,on_click:function(){s.apply_region_scope(this.model,"local"),h.show(),f.find(".upfront-region-bg-setting-is-global").hide(),c.$el.show(),this.$el.hide()},rendered:function(){this.$el.attr("title",t.localize_region_info)}}),m=new i.Button({model:this.model,name:"save",label:t.ok.toLowerCase(),compact:!0,classname:"upfront-region-bg-setting-name-save",on_click:function(){f.find(".upfront-region-bg-setting-name-wrap").show(),h.show(),f.find(".upfront-region-bg-setting-name-edit").hide(),s.toggle_editable_region_panels(!0),"global"==this.model.get("scope")?(c.$el.hide(),u._no_display||u.$el.show()):c.$el.show()}}),f=n.find(".upfront-region-bg-setting-name"),h=n.parent().find(".upfront-region-bg-setting-auto-resize");if(l)return void n.hide();if(f.append(d()),p.render(),c.render(),u.render(),m.render(),f.find(".upfront-region-bg-setting-name-edit").append([p.$el,c.$el,u.$el,m.$el]).hide(),f.find(".upfront-region-name-edit-value").text(this.model.get("title")),"global"==this.model.get("scope")){if(f.find(".upfront-region-bg-setting-is-global").show(),c.$el.hide(),!this.model.is_main()&&a){var b=this.model.collection.get_by_name(this.model.get("container"));b&&"global"==b.get("scope")&&(u.$el.hide(),u._no_display=!0)}}else f.find(".upfront-region-bg-setting-is-global").hide(),u.$el.hide();f.on("click",".upfront-region-name-edit-trigger",function(e){e.preventDefault(),f.find(".upfront-region-bg-setting-name-wrap").hide(),h.hide(),s.toggle_editable_region_panels(!1),f.find(".upfront-region-bg-setting-name-edit").show(),"global"!=s.model.get("scope")?p.get_field().prop("disabled",!1).trigger("focus").select():p.get_field().prop("disabled",!0)}),this.model.is_main()?(h.on("click",function(t){t.preventDefault(),t.stopPropagation(),s.trigger_expand_lock(e(this))}),this.render_expand_lock(h)):h.hide()},toggle_editable_region_panels:function(t){return t?e(".upfront-bg-setting-type, .upfront-region-bg-setting-region-style-container, .upfront-region-bg-setting-footer, .upfront-bg-setting-tab, .upfront-region-bg-setting-padding").css({pointerEvents:"auto",opacity:1}):e(".upfront-bg-setting-type, .upfront-region-bg-setting-region-style-container, .upfront-region-bg-setting-footer, .upfront-bg-setting-tab, .upfront-region-bg-setting-padding").css({pointerEvents:"none",opacity:.5})},render_main_settings:function(e){var n=this,o=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),s=o&&!o.default,r=this.model.collection,l=r.indexOf(this.model),a=r.index_container(this.model,["shadow","lightbox"]),g=(r.total_container(["shadow","lightbox"]),new i.Select({model:this.model,name:"type",default_value:"wide",label:t.region_style,layout:"horizontal-inline",values:this.get_region_types(a),change:function(){var e=this.get_value();this.model.set({type:e},{silent:!0}),"full"==e?(m.show(),f.show(),this.model.set({sticky:0},{silent:!0})):(m.hide(),f.hide()),this.model.get("properties").trigger("change"),n.update_pos(),Upfront.Events.trigger("command:region:edit_toggle",!1),Upfront.Events.trigger("command:region:edit_toggle",!0)}})),d=this.model.get_property_value_by_name("nav_region"),p=new i.Checkboxes({model:this.model,property:"sub_regions",default_value:this.model.get_property_value_by_name("sub_regions")?[]:[d],layout:"horizontal-inline",multiple:!0,values:[{label:t.top,value:"top"},{label:t.bottom,value:"bottom"}],change:function(){var e=this.get_value(),t=n.model.get_sub_regions(),i=!1;l=r.indexOf(n.model),!_.contains(e,"top")&&t.top&&(i=Upfront.Util.model_to_json(t.top),n._sub_region_top_copy=new Upfront.Models.Region(i),r.remove(t.top)),!_.contains(e,"bottom")&&t.bottom&&(i=Upfront.Util.model_to_json(t.bottom),n._sub_region_bottom_copy=new Upfront.Models.Region(i),r.remove(t.bottom)),_.each(e,function(e){if(!t[e]){var i=!1,o=!1;if("bottom"==e?(n._sub_region_bottom_copy&&(o=n._sub_region_bottom_copy),i=t.right?l+2:l+1):"top"==e&&(n._sub_region_top_copy&&(o=n._sub_region_top_copy),i=t.left?l-1:l),i!==!1){var s=n.model.get("name")+"_"+e,a=n.model.get("title")+" "+e;o===!1&&(o=new Upfront.Models.Region(_.extend(_.clone(Upfront.data.region_default_args),{name:s,title:a,container:n.model.get("name"),sub:e,scope:n.model.get("scope")}))),o.add_to(r,i,{sub:e}),Upfront.Events.trigger("command:region:edit_toggle",!0)}}}),this.property.set({value:e})}}),c=new i.Radios({model:this.model,name:"behavior",default_value:"keep-position",layout:"horizontal-inline",values:[{label:t.keep_position,value:"keep-position"},{label:t.keep_ratio,value:"keep-ratio"}],change:function(){var e=this.get_value();this.model.set({behavior:e},{silent:!0}),this.model.get("properties").trigger("change")}}),u=e.find(".upfront-region-bg-setting-region-type"),m=e.find(".upfront-region-bg-setting-region-nav"),f=e.find(".upfront-region-bg-setting-region-behavior");!s&&this.model.is_main()?(g.render(),u.append(g.$el),p.render(),m.append(p.$el),c.render(),f.append(c.$el)):(u.hide(),m.hide(),f.hide()),this.model.is_main()&&(this.listenTo(g,"changed",function(){n.render_expand_lock(e.find(".upfront-region-bg-setting-auto-resize"))}),s||g.trigger("changed"))},render_footer_settings:function(e){var t=this,n=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),i=n&&!n.default,o=!this.model.is_main()&&this.model.get("sub"),s=e.find(".upfront-region-bg-setting-sticky");i||!this.model.is_main()&&"top"!=o&&"bottom"!=o?s.hide():this.render_sticky_settings(s),e.find(".upfront-region-bg-setting-edit-css").on("click",function(e){e.preventDefault(),e.stopPropagation(),t.trigger_edit_css()})},render_sticky_settings:function(e){var n=this.model.collection,o=n.findWhere({sticky:"1"}),s=new i.Checkboxes({model:this.model,name:"sticky",default_value:"",layout:"horizontal-inline",values:[{label:t.sticky_region+":",value:"1"}],change:function(){var e=this.get_value();this.model.set({sticky:e},{silent:!0}),this.model.get("properties").trigger("change")},multiple:!1});!o&&this.for_view.$el.height()<=300||this.model.get("sticky")?(s.render(),s.$el.find("label").append('<span class="upfront-bg-setting-sticky-toggle"></span>'),e.append(s.$el)):e.hide()},render_padding_settings:function(n){var s,r,l,a,g=e(o),d=_.template(g.find("#upfront-region-bg-setting-padding").html()),p=new i.Checkboxes({model:this.model,use_breakpoint_property:!0,property:"bg_padding_type",label:"",values:[{label:" ",value:"varied"},{label:t.equal_padding,value:"equal"}],multiple:!1,default_value:this.model.get_breakpoint_property_value("bg_padding_type")||"equal",change:function(){this.model.set_breakpoint_property("bg_padding_type",this.get_value())},show:function(t,i){"varied"===t?(e(".upfront-region-bg-setting-padding-top",n).show(),e(".upfront-region-bg-setting-padding-bottom",n).show(),e(".upfront-region-bg-setting-equal-padding",n).hide()):(e(".upfront-region-bg-setting-equal-padding",n).show(),e(".upfront-region-bg-setting-padding-top",n).hide(),e(".upfront-region-bg-setting-padding-bottom",n).hide())}}),c=new i.Number({model:this.model,use_breakpoint_property:!0,property:"top_bg_padding_num",label:"",default_value:this.model.get_breakpoint_property_value("top_bg_padding_num")||0,prefix:t.bottom_padding,suffix:t.px,min:0,step:5,change:function(){var e=this.get_value();this.model.set_breakpoint_property("top_bg_padding_num",e)}}),u=new i.Number({model:this.model,use_breakpoint_property:!0,property:"bottom_bg_padding_num",label:"",default_value:this.model.get_breakpoint_property_value("bottom_bg_padding_num")||0,suffix:t.px,min:0,step:5,change:function(){var e=this.get_value();this.model.set_breakpoint_property("bottom_bg_padding_num",e)}}),m=new i.Number({model:this.model,use_breakpoint_property:!0,property:"bg_padding_num",label:"",default_value:this.model.get_breakpoint_property_value("bg_padding_num")||0,suffix:t.px,min:0,step:5,change:function(){var e=this.get_value();this.model.set_breakpoint_property("bg_padding_num",e),c.get_field().val(e),u.get_field().val(e),this.model.set_breakpoint_property("top_bg_padding_num",e,!0),this.model.set_breakpoint_property("bottom_bg_padding_num",e,!0)}}),f=new i.Select({model:this.model,use_breakpoint_property:!0,property:"region_role",label:t.roles_select_label,default_value:this.model.get_breakpoint_property_value("region_role"),values:[{label:t.roles.none,value:""},{label:t.roles.banner,value:"banner"},{label:t.roles.main,value:"main"},{label:t.roles.complementary,value:"complementary"},{label:t.roles.contentinfo,value:"contentinfo"}],change:function(){var e=this.get_value();this.model.set_breakpoint_property("region_role",e)}});n.append(d()),s=n.find(".upfront-region-bg-setting-padding-type"),r=n.find(".upfront-region-bg-setting-equal-padding"),l=n.find(".upfront-region-bg-setting-padding-top"),a=n.find(".upfront-region-bg-setting-padding-bottom"),"varied"===this.model.get_breakpoint_property_value("bg_padding_type")?r.hide():(l.hide(),a.hide()),p.render(),s.append(p.$el),c.render(),l.append(c.$el),u.render(),a.append(u.$el),m.render(),r.append(m.$el),f.render(),n.find(".upfront-region-bg-setting-aria-role").append(f.$el)},apply_region_scope:function(e,t,n,i){var o,s=this,r=e.get_sub_regions(),l=e.get("title"),a=e.get("name"),g=function(e){var o=s.get_region_css_styles(e);if(e.set({scope:t},{silent:!0}),n&&a!=n){var r=new RegExp("^"+l,"i"),g=new RegExp("^"+a,"i"),d=e.get("title").replace(r,i),p=e.get("name").replace(g,n);e.set({container:n,title:d,name:p},{silent:!0})}s.set_region_css_styles(e,o.styles,o.selector),e.get("properties").trigger("change")};e.is_main()&&_.each(r,function(e){_.isArray(e)?_.each(e,function(e){g(e)}):e&&g(e)}),o=s.get_region_css_styles(e),e.set({scope:t},{silent:!0}),n&&a!=n&&e.set({title:i,name:n,container:n},{silent:!0}),s.set_region_css_styles(e,o.styles,o.selector),e.get("properties").trigger("change")},get_region_css_styles:function(t){return Upfront.Application.cssEditor.init({model:t,type:t.is_main()?"RegionContainer":"Region",element_id:t.is_main()?"region-container-"+t.get("name"):"region-"+t.get("name"),no_render:!0}),{styles:e.trim(Upfront.Application.cssEditor.get_style_element().html()),selector:Upfront.Application.cssEditor.get_css_selector()}},set_region_css_styles:function(e,t,n){t&&(Upfront.Application.cssEditor.init({model:e,type:e.is_main()?"RegionContainer":"Region",element_id:e.is_main()?"region-container-"+e.get("name"):"region-"+e.get("name"),no_stylename_fallback:!0,no_render:!0}),selector=Upfront.Application.cssEditor.get_css_selector(),n!=selector&&(t=t.replace(new RegExp(n.replace(/^\./,"."),"g"),selector)),Upfront.Application.cssEditor.get_style_element().html(t),Upfront.Application.cssEditor.saveCall(!1))},render_expand_lock:function(n){var i=this.model.get_breakpoint_property_value("expand_lock",!0),o=this.model.get("type"),s=e("<span />");"full"==o?(n.addClass("upfront-region-bg-setting-auto-resize-disabled"),n.attr("title",t.auto_resize_disabled_title)):(n.removeClass("upfront-region-bg-setting-auto-resize-disabled"),n.removeAttr("title")),i?s.addClass("auto-resize-off"):s.addClass("auto-resize-on"),n.html(""),n.append("<span>"+t.auto_resize+"</span>"),n.append(s)},trigger_expand_lock:function(e){if(!e.hasClass("upfront-region-bg-setting-auto-resize-disabled")){var t=this.model.get_breakpoint_property_value("expand_lock");this.model.set_breakpoint_property("expand_lock",!t),this.render_expand_lock(e)}},trigger_edit_css:function(){Upfront.Application.cssEditor.init({model:this.model,type:this.model.is_main()?"RegionContainer":"lightbox"==this.model.get("type")?"RegionLightbox":"Region",element_id:this.model.is_main()?"region-container-"+this.model.get("name"):"region-"+this.model.get("name")}),this.listenTo(Upfront.Application.cssEditor,"updateStyles",this.adjust_grid_padding)},toggle_advanced_settings:function(){this.$el.find(".advanced-settings").hasClass("uf-settings-panel--expanded")?this.$el.find(".advanced-settings").removeClass("uf-settings-panel--expanded").find(".uf-settings-panel__body").hide():this.$el.find(".advanced-settings").addClass("uf-settings-panel--expanded").find(".uf-settings-panel__body").show(),this.set_settings_content_max_height()},on_click_cancel:function(){return this.reset_models(),this.close(!1)},adjust_grid_padding:function(){var e=new Upfront.Views.Editor.Command_ToggleGrid;e.update_grid()}})})}(jQuery);